#!/bin/bash

# ============================================
# Gitleaks Pre-Commit Hook
# Scans staged files for secrets before commit
# ============================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

GITLEAKS_ENABLED=$(git config --get hooks.gitleaks)

if [ "$GITLEAKS_ENABLED" != "true" ]; then
    echo -e "${YELLOW}[SKIP]${NC} Gitleaks hook disabled. Enable: git config hooks.gitleaks true"
    exit 0
fi

if ! command -v gitleaks &> /dev/null; then
    echo -e "${RED}[ERROR]${NC} gitleaks is not installed!"
    echo "Install via: curl -sSL https://raw.githubusercontent.com/Iamfittz/gitleaks-hook/main/install.sh | sh"
    exit 1
fi

echo -e "${YELLOW}[INFO]${NC} Running secrets scan..."

gitleaks detect --staged --verbose --redact

if [ $? -eq 0 ]; then
    echo -e "${GREEN}[OK]${NC} No secrets detected. Commit allowed."
    exit 0
else
    echo -e "${RED}[BLOCKED]${NC} Secrets detected! Commit rejected."
    echo -e "${YELLOW}What to do:${NC}"
    echo "  1. Remove secrets from code"
    echo "  2. Use environment variables"
    echo "  3. Add file to .gitignore"
    echo ""
    echo -e "Skip check (not recommended): git commit --no-verify"
    exit 1
fi
